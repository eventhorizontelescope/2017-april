#!/usr/bin/env bash

mkdir -p tests temp log
find $SRCDIR -name '*.polcal.uvfits' -type f |\
while read l; do
	r=${l#$SRCDIR/}
	d=$(dirname  $r)
	f=$(basename $r)
	n=${f%.polcal.uvfits}
	s=$(echo $n | tr '_' '\t' | cut -f3)
	z=$(sed -n "/$s\t$d\t$BAND/Ip" $METADIR/zbl.tsv | cut -f 4)
	echo "Network-cal \"$l\" with zbl-flux $z"
	mkdir -p $d && pushd $d > /dev/null

	/usr/bin/time -v \
		calibrate.py -z $z -p R -r $l \
		>> ../log/$n.RR.log 2>&1
	if [ -d "$SRCDIR/$d/$n.RR" ]; then
		if [ -d "$n.RR" ]; then
			mv "$SRCDIR/$d/$n.RR"/* "$n.RR"
			rmdir "$SRCDIR/$d/$n.RR/"
		else
			mv "$SRCDIR/$d/$n.RR" .
		fi
	fi

	/usr/bin/time -v \
		calibrate.py -z $z -p L -r $l \
		>> ../log/$n.LL.log 2>&1
	if [ -d "$SRCDIR/$d/$n.LL" ]; then
		if [ -d "$n.LL" ]; then
			mv "$SRCDIR/$d/$n.LL"/* "$n.LL"
			rmdir "$SRCDIR/$d/$n.LL/"
		else
			mv "$SRCDIR/$d/$n.LL" .
		fi
	fi

	popd > /dev/null
done
